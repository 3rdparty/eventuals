load("@rules_cc//cc:defs.bzl", "cc_library")
load("//bazel:copts.bzl", "copts")

cc_library(
    name = "eventuals-base",
    srcs = [
        "eventuals/scheduler.cc",
        "eventuals/static-thread-pool.cc",
    ],
    hdrs = [
        "eventuals/callback.h",
        "eventuals/catch.h",
        "eventuals/closure.h",
        "eventuals/collect.h",
        "eventuals/compose.h",
        "eventuals/concurrent.h",
        "eventuals/conditional.h",
        "eventuals/context.h",
        "eventuals/do-all.h",
        "eventuals/eventual.h",
        "eventuals/filter.h",
        "eventuals/finally.h",
        "eventuals/foreach.h",
        "eventuals/generator.h",
        "eventuals/head.h",
        "eventuals/interrupt.h",
        "eventuals/iterate.h",
        "eventuals/just.h",
        "eventuals/let.h",
        "eventuals/lock.h",
        "eventuals/loop.h",
        "eventuals/map.h",
        "eventuals/os.h",
        "eventuals/raise.h",
        "eventuals/range.h",
        "eventuals/reduce.h",
        "eventuals/repeat.h",
        "eventuals/scheduler.h",
        "eventuals/semaphore.h",
        "eventuals/sequence.h",
        "eventuals/static-thread-pool.h",
        "eventuals/stream.h",
        "eventuals/stream-for-each.h",
        "eventuals/take.h",
        "eventuals/task.h",
        "eventuals/terminal.h",
        "eventuals/then.h",
        "eventuals/type-traits.h",
        "eventuals/undefined.h",
        "eventuals/until.h",
    ],
    copts = copts(),
    visibility = ["//visibility:private"],
    deps = [
        "@com_github_google_glog//:glog",
    ] + select({
        # NOTE!
        # For now we build jemalloc on macOS and Linux.
        # The way how to build jemalloc on Windows is more
        # complicated. In future we are going to make this
        # lib build on Windows too.
        # https://github.com/3rdparty/bazel-rules-jemalloc/tree/ArthurBandaryk.jemalloc-windows
        "@bazel_tools//src/conditions:windows": [],
        "//conditions:default": [
            "@com_github_jemalloc_jemalloc//:jemalloc",
        ],
    }),
)

cc_library(
    name = "eventuals-events",
    srcs = [
        "eventuals/event-loop.cc",
    ],
    hdrs = [
        "eventuals/dns-resolver.h",
        "eventuals/event-loop.h",
        "eventuals/filesystem.h",
        "eventuals/signal.h",
        "eventuals/timer.h",
    ],
    copts = copts(),
    visibility = ["//visibility:private"],
    deps = [
        ":eventuals-base",
        "@com_github_libuv_libuv//:libuv",
    ],
)

cc_library(
    name = "eventuals-http",
    srcs = [
        "eventuals/http.cc",
    ],
    hdrs = [
        "eventuals/http.h",
    ],
    copts = copts(),
    defines = [
        # Windows build fails without this define.
        "GLOG_NO_ABBREVIATED_SEVERITIES",
    ],
    # Gives the error "undefined symbol: curl_global_init" if False.
    # Default is False.
    linkstatic = True,
    visibility = ["//visibility:private"],
    deps = [
        ":eventuals-base",
        ":eventuals-events",
        # NOTE: Links against BoringSSL for HTTPS stuff.
        # Compiles without any SSL support on Windows.
        # See bazel-rules-curl for more details.
        "@com_github_curl_curl//:libcurl",
    ],
)

cc_library(
    name = "eventuals",
    copts = copts(),
    visibility = ["//visibility:public"],
    deps = [
        ":eventuals-base",
        ":eventuals-events",
        ":eventuals-http",
    ],
)
